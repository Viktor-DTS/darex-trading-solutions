<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è bonusApprovalDate</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        button {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            color: white;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</h1>
            <p>–ü—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö</p>
        </div>
        
        <div class="content">
            <p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> 220+ –∑–∞—è–≤–æ–∫ –±–µ–∑ bonusApprovalDate</p>
            <p><strong>–†—ñ—à–µ–Ω–Ω—è:</strong> –ü—Ä—è–º–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ API</p>
            
            <button onclick="emergencyFix()">
                üö® –í–ò–ü–†–ê–í–ò–¢–ò –í–°–ï –ó–ê–†–ê–ó
            </button>
            
            <button onclick="checkStatus()">
                üìä –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
            </button>
            
            <div class="log" id="log"></div>
            
            <div class="result" id="result">
                <div id="resultContent"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://darex-trading-solutions.onrender.com/api';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function showResult(type, content) {
            const result = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            result.className = `result ${type}`;
            result.style.display = 'block';
            resultContent.innerHTML = content;
        }
        
        async function emergencyFix() {
            log('üö® –ü–æ—á–∞—Ç–æ–∫ –µ–∫—Å—Ç—Ä–µ–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...');
            
            try {
                // –ö—Ä–æ–∫ 1: –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –∑–∞—è–≤–∫–∏
                log('üì• –û—Ç—Ä–∏–º—É—î–º–æ –≤—Å—ñ –∑–∞—è–≤–∫–∏...');
                const tasksResponse = await fetch(`${API_BASE}/tasks`);
                
                if (!tasksResponse.ok) {
                    throw new Error(`HTTP ${tasksResponse.status}: ${tasksResponse.statusText}`);
                }
                
                const tasks = await tasksResponse.json();
                log(`üìä –ó–Ω–∞–π–¥–µ–Ω–æ ${tasks.length} –∑–∞—è–≤–æ–∫`);
                
                // –ö—Ä–æ–∫ 2: –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∑–∞—è–≤–∫–∏, —è–∫—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è
                const tasksToFix = tasks.filter(task => {
                    const isApproved = task.approvedByWarehouse === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' && 
                                     task.approvedByAccountant === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' && 
                                     task.approvedByRegionalManager === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ';
                    const hasWorkPrice = task.workPrice && task.workPrice > 0;
                    const needsBonusDate = !task.bonusApprovalDate || 
                                         task.bonusApprovalDate === '' || 
                                         task.bonusApprovalDate === null ||
                                         /^\d{4}-\d{2}-\d{2}$/.test(task.bonusApprovalDate);
                    
                    return isApproved && hasWorkPrice && needsBonusDate;
                });
                
                log(`üéØ –ó–Ω–∞–π–¥–µ–Ω–æ ${tasksToFix.length} –∑–∞—è–≤–æ–∫ –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è`);
                
                if (tasksToFix.length === 0) {
                    showResult('success', '<h3>‚úÖ –í—Å—ñ –∑–∞—è–≤–∫–∏ –≤–∂–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ!</h3>');
                    return;
                }
                
                // –ö—Ä–æ–∫ 3: –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ–∂–Ω—É –∑–∞—è–≤–∫—É
                let fixedCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < tasksToFix.length; i++) {
                    const task = tasksToFix[i];
                    const progress = Math.round((i / tasksToFix.length) * 100);
                    
                    try {
                        // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏
                        let bonusApprovalDate;
                        
                        if (task.bonusApprovalDate && /^\d{4}-\d{2}-\d{2}$/.test(task.bonusApprovalDate)) {
                            // –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç
                            const [year, month] = task.bonusApprovalDate.split('-');
                            bonusApprovalDate = `${month}-${year}`;
                        } else {
                            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤—É –¥–∞—Ç—É
                            const now = new Date();
                            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                            const currentYear = now.getFullYear();
                            bonusApprovalDate = `${currentMonth}-${currentYear}`;
                        }
                        
                        // –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞—è–≤–∫—É
                        const updateResponse = await fetch(`${API_BASE}/tasks/${task._id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ bonusApprovalDate: bonusApprovalDate })
                        });
                        
                        if (updateResponse.ok) {
                            fixedCount++;
                            log(`‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞—è–≤–∫—É ${task._id}: ${bonusApprovalDate} (${progress}%)`);
                        } else {
                            errorCount++;
                            log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞—è–≤–∫–∏ ${task._id}: ${updateResponse.status}`);
                        }
                        
                    } catch (error) {
                        errorCount++;
                        log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞—è–≤–∫–∏ ${task._id}: ${error.message}`);
                    }
                    
                    // –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –Ω–µ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–µ—Ä–≤–µ—Ä
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                log(`üéâ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: ${fixedCount}, –ü–æ–º–∏–ª–æ–∫: ${errorCount}`);
                
                showResult('success', `
                    <h3>üéâ –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</h3>
                    <p><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏:</strong></p>
                    <p>–ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞—è–≤–æ–∫: <strong>${tasksToFix.length}</strong></p>
                    <p>–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: <strong>${fixedCount}</strong></p>
                    <p>–ü–æ–º–∏–ª–æ–∫: <strong>${errorCount}</strong></p>
                    <p><em>–¢–µ–ø–µ—Ä –ø—Ä–µ–º—ñ—ó –ø–æ–≤–∏–Ω–Ω—ñ –Ω–∞—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!</em></p>
                `);
                
            } catch (error) {
                log(`‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${error.message}`);
                showResult('error', `
                    <h3>‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</h3>
                    <p><strong>–ü–æ–º–∏–ª–∫–∞:</strong> ${error.message}</p>
                    <p><em>–°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ –∞–±–æ –∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.</em></p>
                `);
            }
        }
        
        async function checkStatus() {
            log('üìä –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–æ–∫...');
            
            try {
                const tasksResponse = await fetch(`${API_BASE}/tasks`);
                
                if (!tasksResponse.ok) {
                    throw new Error(`HTTP ${tasksResponse.status}: ${tasksResponse.statusText}`);
                }
                
                const tasks = await tasksResponse.json();
                
                const approvedTasks = tasks.filter(task => 
                    task.approvedByWarehouse === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' && 
                    task.approvedByAccountant === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' && 
                    task.approvedByRegionalManager === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' &&
                    task.workPrice && task.workPrice > 0
                );
                
                const tasksWithBonusDate = approvedTasks.filter(task => 
                    task.bonusApprovalDate && 
                    task.bonusApprovalDate !== '' && 
                    task.bonusApprovalDate !== null &&
                    !/^\d{4}-\d{2}-\d{2}$/.test(task.bonusApprovalDate)
                );
                
                const tasksWithoutBonusDate = approvedTasks.filter(task => 
                    !task.bonusApprovalDate || 
                    task.bonusApprovalDate === '' || 
                    task.bonusApprovalDate === null
                );
                
                const tasksWithInvalidFormat = approvedTasks.filter(task => 
                    task.bonusApprovalDate && /^\d{4}-\d{2}-\d{2}$/.test(task.bonusApprovalDate)
                );
                
                log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞—è–≤–æ–∫:`);
                log(`   –í—Å—å–æ–≥–æ –∑–∞—è–≤–æ–∫: ${tasks.length}`);
                log(`   –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏—Ö –∑–∞—è–≤–æ–∫: ${approvedTasks.length}`);
                log(`   –ó –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º bonusApprovalDate: ${tasksWithBonusDate.length}`);
                log(`   –ë–µ–∑ bonusApprovalDate: ${tasksWithoutBonusDate.length}`);
                log(`   –ó –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º: ${tasksWithInvalidFormat.length}`);
                
                showResult('success', `
                    <h3>üìä –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–æ–∫</h3>
                    <p><strong>–í—Å—å–æ–≥–æ –∑–∞—è–≤–æ–∫:</strong> ${tasks.length}</p>
                    <p><strong>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∏—Ö –∑–∞—è–≤–æ–∫:</strong> ${approvedTasks.length}</p>
                    <p><strong>–ó –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º bonusApprovalDate:</strong> ${tasksWithBonusDate.length}</p>
                    <p><strong>–ë–µ–∑ bonusApprovalDate:</strong> ${tasksWithoutBonusDate.length}</p>
                    <p><strong>–ó –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ñ–æ—Ä–º–∞—Ç–æ–º:</strong> ${tasksWithInvalidFormat.length}</p>
                `);
                
            } catch (error) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å—É: ${error.message}`);
                showResult('error', `
                    <h3>‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</h3>
                    <p><strong>–ü–æ–º–∏–ª–∫–∞:</strong> ${error.message}</p>
                `);
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        window.onload = function() {
            log('üöÄ –ï–∫—Å—Ç—Ä–µ–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
            checkStatus();
        };
    </script>
</body>
</html>
