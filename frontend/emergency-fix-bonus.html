<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–µ–º—ñ–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d32f2f;
            text-align: center;
            margin-bottom: 30px;
        }
        .button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #1565c0;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .emergency-button {
            background: #d32f2f;
            font-size: 18px;
            padding: 15px 30px;
        }
        .emergency-button:hover {
            background: #b71c1c;
        }
        .progress-container {
            margin: 20px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.3s;
        }
        .log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log p {
            margin: 2px 0;
            padding: 2px 0;
        }
        .info { color: #1976d2; }
        .success { color: #4caf50; font-weight: bold; }
        .error { color: #d32f2f; font-weight: bold; }
        .warning { color: #ff9800; font-weight: bold; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #1976d2;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® –ï–∫—Å—Ç—Ä–µ–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–µ–º—ñ–π</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">-</div>
                <div class="stat-label">–í—Å—å–æ–≥–æ –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tasksToFix">-</div>
                <div class="stat-label">–ü–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="updatedTasks">0</div>
                <div class="stat-label">–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="skippedTasks">0</div>
                <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button id="fixButton" class="button emergency-button" onclick="fixAllBonusDates()">
                üö® –í–ò–ü–†–ê–í–ò–¢–ò –í–°–ï –ó–ê–†–ê–ó
            </button>
        </div>

        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>–ü—Ä–æ–≥—Ä–µ—Å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div id="log" class="log"></div>
    </div>

    <script>
        const API_BASE_URL = 'https://darex-trading-solutions.onrender.com/api';
        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const fixButton = document.getElementById('fixButton');
        const totalTasksEl = document.getElementById('totalTasks');
        const tasksToFixEl = document.getElementById('tasksToFix');
        const updatedTasksEl = document.getElementById('updatedTasks');
        const skippedTasksEl = document.getElementById('skippedTasks');

        function appendLog(message, type = 'info') {
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStats(total, toFix, updated, skipped) {
            totalTasksEl.textContent = total;
            tasksToFixEl.textContent = toFix;
            updatedTasksEl.textContent = updated;
            skippedTasksEl.textContent = skipped;
        }

        async function fetchAllTasks() {
            appendLog('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –∑–∞—è–≤–æ–∫...');
            try {
                const response = await fetch(`${API_BASE_URL}/tasks`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                appendLog(`–ó–Ω–∞–π–¥–µ–Ω–æ ${data.tasks.length} –∑–∞—è–≤–æ–∫.`);
                return data.tasks;
            } catch (error) {
                appendLog(`–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞—è–≤–æ–∫: ${error.message}`, 'error');
                throw error;
            }
        }

        async function updateTask(task) {
            try {
                const response = await fetch(`${API_BASE_URL}/tasks/${task._id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(task)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || JSON.stringify(errorData)}`);
                }
                return await response.json();
            } catch (error) {
                appendLog(`–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞—è–≤–∫–∏ ${task._id}: ${error.message}`, 'error');
                throw error;
            }
        }

        function isApproved(status) {
            return status === '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ' || status === true;
        }

        function getBonusApprovalDate(task) {
            if (task.bonusApprovalDate) {
                // Check for YYYY-MM-DD format and convert to MM-YYYY
                if (/^\d{4}-\d{2}-\d{2}$/.test(task.bonusApprovalDate)) {
                    const [year, month] = task.bonusApprovalDate.split('-');
                    return `${month}-${year}`;
                }
                // Assume MM-YYYY or other valid format
                return task.bonusApprovalDate;
            }
            return null;
        }

        async function fixAllBonusDates() {
            fixButton.disabled = true;
            fixButton.textContent = '–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...';
            logDiv.innerHTML = '';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            try {
                const allTasks = await fetchAllTasks();
                let tasksToFix = [];

                appendLog('–ê–Ω–∞–ª—ñ–∑ –∑–∞—è–≤–æ–∫ –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è...');
                for (const task of allTasks) {
                    const currentBonusDate = getBonusApprovalDate(task);
                    const isWarehouseApproved = isApproved(task.approvedByWarehouse);
                    const isAccountantApproved = isApproved(task.approvedByAccountant);
                    const isRegionalManagerApproved = isApproved(task.approvedByRegionalManager);
                    const hasWorkPrice = (parseFloat(task.workPrice) || 0) > 0;

                    if (isWarehouseApproved && isAccountantApproved && hasWorkPrice) {
                        if (!currentBonusDate || !/^\d{2}-\d{4}$/.test(currentBonusDate)) {
                            tasksToFix.push(task);
                        }
                    }
                }
                appendLog(`–ó–Ω–∞–π–¥–µ–Ω–æ ${tasksToFix.length} –∑–∞—è–≤–æ–∫, —â–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è.`);
                updateStats(allTasks.length, tasksToFix.length, 0, 0);

                let updatedCount = 0;
                let skippedCount = 0;

                for (let i = 0; i < tasksToFix.length; i++) {
                    const task = tasksToFix[i];
                    const progress = Math.round(((i + 1) / tasksToFix.length) * 100);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;

                    try {
                        const now = new Date();
                        const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                        const currentYear = now.getFullYear();
                        const newBonusApprovalDate = `${currentMonth}-${currentYear}`;

                        const updatedTaskData = { ...task, bonusApprovalDate: newBonusApprovalDate };
                        await updateTask(updatedTaskData);
                        appendLog(`‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞—è–≤–∫—É ${task._id}: bonusApprovalDate –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${newBonusApprovalDate}`, 'success');
                        updatedCount++;
                    } catch (error) {
                        appendLog(`‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ –∑–∞—è–≤–∫—É ${task._id} —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫—É: ${error.message}`, 'error');
                        skippedCount++;
                    }

                    updateStats(allTasks.length, tasksToFix.length, updatedCount, skippedCount);
                }

                appendLog('--- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ ---', 'info');
                appendLog(`–í—Å—å–æ–≥–æ –∑–Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è: ${tasksToFix.length}`, 'info');
                appendLog(`–£—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ: ${updatedCount}`, 'success');
                appendLog(`–ü—Ä–æ–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ –ø–æ–º–∏–ª–∫–∏: ${skippedCount}`, 'error');

            } catch (error) {
                appendLog(`–ó–∞–≥–∞–ª—å–Ω–∞ –ø–æ–º–∏–ª–∫–∞: ${error.message}`, 'error');
            } finally {
                fixButton.disabled = false;
                fixButton.textContent = 'üö® –í–ò–ü–†–ê–í–ò–¢–ò –í–°–ï –ó–ê–†–ê–ó';
            }
        }

        // Initialize
        appendLog('–°–∫—Ä–∏–ø—Ç –µ–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–µ–º—ñ–π –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏', 'info');
        appendLog('–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–í–ò–ü–†–ê–í–ò–¢–ò –í–°–ï –ó–ê–†–ê–ó" –¥–ª—è –ø–æ—á–∞—Ç–∫—É', 'info');
    </script>
</body>
</html>